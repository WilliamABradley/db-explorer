<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
    }

    /* Just have Monaco Fill All Available Space within control */
    #container {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <p>Editor:</p>
  <div id="container"></div>

  <script>
    var editor;
    var model;
    var contexts = {};
    var decorations = [];
    var modifingSelection = false; // Supress updates to selection when making edits.

    function postMessage(type, message) {
      __REACT_WEB_VIEW_BRIDGE.postMessage(JSON.stringify({ type, message }));
    }

    function setValue(name, value) {
      postMessage('setValue', { name, value });
    }

    function sendEvent(name) {
      postMessage('event', name);
    }

    function log(level, log) {
      postMessage('console', { level, log: typeof log === 'string' ? log : JSON.stringify(log) });
    }
    console = {
      log: (msg) => log('log', msg),
      debug: (msg) => log('debug', msg),
      info: (msg) => log('info', msg),
      warn: (msg) => log('warn', msg),
      error: (msg) => log('error', msg),
    };

    window.addEventListener('message', function (payload) {
      var dataPayload;
      try {
        dataPayload = JSON.parse(payload.data);
      } catch (e) {
        throw new Error('Invalid Parent Message');
      }

      if (dataPayload) {
        console.log(`[Parent] ${dataPayload.type}`);
        switch (dataPayload.type) {
          case 'reload':
            loadEditor();
            break;
        }
      }
    });

    console.log('frame connected');
  </script>

  <script src="ms-appx-web:///editor/monaco-editor/min/vs/loader.js"></script>

  <script>
    console.log("loading editor");
    function loadEditor() {
      console.log("Starting Monaco Load");
      require.config({ paths: { 'vs': 'ms-appx-web:///editor/monaco-editor/min/vs' } });
      require(['vs/editor/editor.main.js'], function () {
        log("info", "Creating Editor...");
        editor = monaco.editor.create(document.getElementById('container'), {
          value: [
            'function x() {',
            '\tconsole.log("Hello world!");',
            '}'
          ].join('\n'),
          language: 'javascript'
        });
        model = editor.getModel();

        // Listen for Content Changes
        model.onDidChangeContent((event) => {
          setValue("Text", model.getValue());
          console.log("buffers: " + JSON.stringify(model._buffer._pieceTree._buffers));
          console.log("commandMgr: " + JSON.stringify(model._commandManager));
          console.log("viewState:" + JSON.stringify(editor.saveViewState()));
        });

        // Listen for Selection Changes
        editor.onDidChangeCursorSelection((event) => {
          if (!modifingSelection) {
            console.log(event.source);
            setValue("SelectedText", model.getValueInRange(event.selection));
            setValue("SelectedRange", JSON.stringify(event.selection), "Selection");
          }
        });

        // Update Monaco Size when we receive a window resize event
        window.addEventListener("resize", () => {
          editor.layout();
        });

        // Disable WebView Scrollbar so Monaco Scrollbar can do heavy lifting
        document.body.style.overflow = 'hidden';

        // Callback to Parent that we're loaded
        console.log("Loaded Monaco");
        sendEvent("Loaded");
      }, function (err) {
        console.error(err);
        sendEvent("LoadFailed");
      });
    }
    loadEditor();
  </script>
</body>

</html>